<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>C·∫≠p nh·∫≠t t√†i kho·∫£n</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    /* CSS thay th·∫ø cho common.css */
    .readonly-input {
      background-color: #f0f0f0;
      cursor: not-allowed;
    }
    .account-status {
      display: flex;
      align-items: center;
      gap: 8px;
    }
  </style>
</head>
<body>
<div class="container py-4">
  <div class="card shadow">
    <div class="card-header bg-primary text-white">
      <h2 class="mb-0"><i class="fas fa-user-edit me-2"></i>C·∫≠p nh·∫≠t t√†i kho·∫£n</h2>
    </div>

    <div class="card-body">
      <form id="updateForm">
        <div class="mb-3">
          <label for="username" class="form-label">Username:</label>
          <input type="text" id="username" class="form-control readonly-input" readonly>
        </div>

        <div class="mb-3">
          <label for="employeeName" class="form-label">T√™n nh√¢n vi√™n:</label>
          <input type="text" id="employeeName" class="form-control">
        </div>

        <div class="mb-3">
          <label for="email" class="form-label">Email:</label>
          <input type="email" id="email" class="form-control readonly-input" readonly>
        </div>

        <div class="mb-3">
          <label for="department" class="form-label">ƒê∆°n v·ªã:</label>
          <select id="department" class="form-select"></select>
        </div>

        <div class="mb-3">
          <label for="role" class="form-label">Quy·ªÅn:</label>
          <select id="role" class="form-select"></select>
        </div>

        <div class="mb-3 form-check">
          <div class="account-status">
            <input type="checkbox" id="active" class="form-check-input">
            <label class="form-check-label" for="active">T√†i kho·∫£n ho·∫°t ƒë·ªông</label>
          </div>
        </div>

        <div class="d-flex justify-content-between mt-4">
          <button type="button" id="saveBtn" class="btn btn-primary">
            <i class="fas fa-save me-2"></i>L∆∞u
          </button>
          <button type="button" id="resetBtn" class="btn btn-warning">
            <i class="fas fa-key me-2"></i>ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u
          </button>
          <button type="button" onclick="window.location.href='/users'" class="btn btn-danger">
            <i class="fas fa-times me-2"></i>H·ªßy
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u -->
<div class="modal fade" id="passwordModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title"><i class="fas fa-key me-2"></i>ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Nh·∫≠p m·∫≠t kh·∫©u m·ªõi cho t√†i kho·∫£n:</p>
        <input type="password" id="newPassword" class="form-control" placeholder="M·∫≠t kh·∫©u m·ªõi">
        <div class="mt-2 text-muted small">
          <i class="fas fa-info-circle me-1"></i>M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 10 k√Ω t·ª±, bao g·ªìm ch·ªØ hoa, ch·ªØ th∆∞·ªùng v√† k√Ω t·ª± ƒë·∫∑c bi·ªát
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-1"></i>H·ªßy
        </button>
        <button type="button" id="confirmResetBtn" class="btn btn-primary">
          <i class="fas fa-check me-1"></i>X√°c nh·∫≠n
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS Bundle v·ªõi Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // L·∫•y username t·ª´ URL
  const urlParts = window.location.pathname.split('/');
  const username = urlParts[urlParts.length - 1];
  let currentUserData = null;
  let passwordModal = null;

  // üîπ L·∫•y th√¥ng tin user
  async function fetchUserData() {
    try {
      const response = await fetch(`/api/v1/users/getUserByUsername/${username}`);
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      const result = await response.json();
      console.log('D·ªØ li·ªáu user t·ª´ API:', result);

      if (result) {
        currentUserData = result;
        populateUserForm(result);
      } else {
        console.error('Kh√¥ng c√≥ d·ªØ li·ªáu user');
      }
    } catch (error) {
      console.error('L·ªói khi l·∫•y d·ªØ li·ªáu ng∆∞·ªùi d√πng:', error);
      showAlert('danger', 'Kh√¥ng th·ªÉ l·∫•y th√¥ng tin ng∆∞·ªùi d√πng');
    }
  }

  // üîπ ƒêi·ªÅn d·ªØ li·ªáu v√†o form
  function populateUserForm(user) {
    console.log('ƒêang ƒëi·ªÅn d·ªØ li·ªáu v√†o form:', user);

    // ƒêi·ªÅn th√¥ng tin c∆° b·∫£n
    document.getElementById('username').value = user.username || '';
    document.getElementById('employeeName').value = user.employeeName || 'Kh√¥ng x√°c ƒë·ªãnh';
    document.getElementById('email').value = user.email || '';
    document.getElementById('active').checked = user.status === 'Active';

    // X·ª≠ l√Ω quy·ªÅn
    if (user.roleName) {
      const roleSelect = document.getElementById('role');
      // ƒê·ª£i dropdown load xong
      setTimeout(() => {
        roleSelect.value = user.roleName;
      }, 100);
    }

    // X·ª≠ l√Ω ƒë∆°n v·ªã
    if (user.departmentId) {
      const departmentSelect = document.getElementById('department');
      // ƒê·ª£i dropdown load xong
      setTimeout(() => {
        departmentSelect.value = user.departmentId;
      }, 100);
    }
  }

  // üîπ L·∫•y danh s√°ch ƒë∆°n v·ªã
  async function fetchDepartments() {
    try {
      const response = await fetch('/api/v1/departments/all');
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      const result = await response.json();
      console.log('D·ªØ li·ªáu departments t·ª´ API:', result);

      let departments = [];

      // X·ª≠ l√Ω nhi·ªÅu ƒë·ªãnh d·∫°ng API tr·∫£ v·ªÅ
      if (Array.isArray(result.data)) {
        departments = result.data;
      } else if (Array.isArray(result)) {
        departments = result;
      } else if (result.retMsg && Array.isArray(result.retMsg)) {
        departments = result.retMsg;
      } else if (typeof result === 'string') {
        // X·ª≠ l√Ω tr∆∞·ªùng h·ª£p API tr·∫£ v·ªÅ string
        const matches = result.match(/Department\(departmentId=(\d+), departmentName=([^,]+)/g);
        if (matches) {
          departments = matches.map(dept => {
            const parts = dept.match(/departmentId=(\d+), departmentName=([^,]+)/);
            return {
              departmentId: parts[1],
              departmentName: parts[2].trim()
            };
          });
        }
      }

      // L·ªçc tr√πng l·∫∑p theo departmentName (gi·ªØ l·∫°i b·∫£n ghi ƒë·∫ßu ti√™n)
      const uniqueDepartments = departments.filter((dept, index, self) =>
                      index === self.findIndex(d => (
                              (d.departmentName || d.name).toLowerCase() ===
                              (dept.departmentName || dept.name).toLowerCase()
                      ))
      );

      // S·∫Øp x·∫øp theo t√™n ƒë∆°n v·ªã (A-Z)
      uniqueDepartments.sort((a, b) =>
              (a.departmentName || a.name || '').localeCompare(b.departmentName || b.name || '')
      );

      const departmentSelect = document.getElementById('department');
      if (!departmentSelect) {
        console.error('Kh√¥ng t√¨m th·∫•y dropdown department');
        return;
      }

      departmentSelect.innerHTML = '<option value="">Ch·ªçn ƒë∆°n v·ªã</option>';

      uniqueDepartments.forEach(dept => {
        const option = document.createElement('option');
        option.value = dept.departmentId || dept.id;
        option.textContent = dept.departmentName || dept.name || 'Kh√¥ng x√°c ƒë·ªãnh';
        departmentSelect.appendChild(option);
      });

      // Ch·ªçn l·∫°i department c·ªßa user n·∫øu c√≥
      if (currentUserData?.departmentId) {
        setTimeout(() => {
          departmentSelect.value = currentUserData.departmentId;
        }, 200);
      }

    } catch (error) {
      console.error('L·ªói khi l·∫•y danh s√°ch ƒë∆°n v·ªã:', error);
      // Th√™m hi·ªÉn th·ªã th√¥ng b√°o l·ªói cho ng∆∞·ªùi d√πng n·∫øu c·∫ßn
      showError('Kh√¥ng th·ªÉ t·∫£i danh s√°ch ƒë∆°n v·ªã. Vui l√≤ng th·ª≠ l·∫°i sau.');
    }
  }

  // üîπ L·∫•y danh s√°ch quy·ªÅn
  async function fetchRoles() {
    try {
      const response = await fetch('/api/v1/roles/all');
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      const result = await response.json();
      console.log('D·ªØ li·ªáu roles t·ª´ API:', result);

      let roles = [];

      // X·ª≠ l√Ω nhi·ªÅu ƒë·ªãnh d·∫°ng API tr·∫£ v·ªÅ
      if (Array.isArray(result.data)) {
        roles = result.data;
      } else if (Array.isArray(result)) {
        roles = result;
      } else if (result.retMsg && Array.isArray(result.retMsg)) {
        roles = result.retMsg;
      } else if (typeof result === 'string') {
        // X·ª≠ l√Ω tr∆∞·ªùng h·ª£p API tr·∫£ v·ªÅ string
        const matches = result.match(/Role\(roleName=([^)]+)/g);
        if (matches) {
          roles = matches.map(role => {
            const roleName = role.match(/roleName=([^)]+)/)[1];
            return { roleName };
          });
        }
      }

      const roleSelect = document.getElementById('role');
      if (!roleSelect) {
        console.error('Kh√¥ng t√¨m th·∫•y dropdown role');
        return;
      }

      roleSelect.innerHTML = '<option value="">Ch·ªçn quy·ªÅn</option>';

      roles.forEach(role => {
        const option = document.createElement('option');
        option.value = role.roleName || role.name;
        option.textContent = role.roleName || role.name || 'Kh√¥ng x√°c ƒë·ªãnh';
        roleSelect.appendChild(option);
      });

      // Ch·ªçn l·∫°i role c·ªßa user n·∫øu c√≥
      if (currentUserData?.roleName) {
        setTimeout(() => {
          roleSelect.value = currentUserData.roleName;
        }, 200);
      }

    } catch (error) {
      console.error('L·ªói khi l·∫•y danh s√°ch quy·ªÅn:', error);
    }
  }

  // üîπ C·∫≠p nh·∫≠t th√¥ng tin user
  async function updateUser() {
    const userData = {
      username: document.getElementById('username').value,
      employeeName: document.getElementById('employeeName').value,
      email: document.getElementById('email').value,
      departmentId: document.getElementById('department').value,
      roleName: document.getElementById('role').value,
      status: document.getElementById('active').checked ? 'Active' : 'Inactive'
    };

    try {
      const response = await fetch(`/api/v1/users/update/${username}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(userData)
      });

      const result = await response.json();
      showAlert('success', result.message || 'C·∫≠p nh·∫≠t th√†nh c√¥ng');
      setTimeout(() => window.location.href = '/users', 1500);
    } catch (error) {
      console.error('L·ªói khi c·∫≠p nh·∫≠t t√†i kho·∫£n:', error);
      showAlert('danger', 'C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t');
    }
  }

  // üîπ ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u
  async function resetPassword() {
    const newPassword = document.getElementById('newPassword').value;

    if (!isValidPassword(newPassword)) {
      showAlert('warning', 'M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 10 k√Ω t·ª±, bao g·ªìm ch·ªØ hoa, ch·ªØ th∆∞·ªùng v√† k√Ω t·ª± ƒë·∫∑c bi·ªát');
      return;
    }

    try {
      const response = await fetch(`/api/v1/users/change-password/${username}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ newPassword })
      });

      const result = await response.json();
      if (result.status === 'SUCCESS') {
        showAlert('success', 'ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u th√†nh c√¥ng');
        passwordModal.hide();
      } else {
        showAlert('danger', result.message || 'C√≥ l·ªói x·∫£y ra');
      }
    } catch (error) {
      console.error('L·ªói khi ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u:', error);
      showAlert('danger', 'C√≥ l·ªói x·∫£y ra khi ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u');
    }
  }

  // üîπ Validate m·∫≠t kh·∫©u
  function isValidPassword(password) {
    return password.length >= 10 &&
            /[A-Z]/.test(password) &&
            /[a-z]/.test(password) &&
            /[^a-zA-Z0-9]/.test(password);
  }

  // üîπ Hi·ªÉn th·ªã th√¥ng b√°o
  function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show mt-3`;
    alertDiv.role = 'alert';
    alertDiv.innerHTML = `
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;

    const container = document.querySelector('.container');
    container.prepend(alertDiv);

    // T·ª± ƒë·ªông ƒë√≥ng th√¥ng b√°o sau 5 gi√¢y
    setTimeout(() => {
      const bsAlert = new bootstrap.Alert(alertDiv);
      bsAlert.close();
    }, 5000);
  }

  // Kh·ªüi t·∫°o trang
  document.addEventListener('DOMContentLoaded', async () => {
    // Kh·ªüi t·∫°o modal
    passwordModal = new bootstrap.Modal(document.getElementById('passwordModal'));

    // Load d·ªØ li·ªáu
    await fetchDepartments();
    await fetchRoles();
    await fetchUserData();

    // G√°n s·ª± ki·ªán
    document.getElementById('saveBtn').addEventListener('click', updateUser);
    document.getElementById('resetBtn').addEventListener('click', () => {
      document.getElementById('newPassword').value = '';
      passwordModal.show();
    });
    document.getElementById('confirmResetBtn').addEventListener('click', resetPassword);
  });
</script>
</body>
</html>