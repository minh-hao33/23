
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Th√¥ng Tin Ph√≤ng Ban</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
        }
        th {
            background-color: #f2f2f2;
            text-align: left;
        }
        th:first-child, td:first-child {
            width: 50px; /* ƒêi·ªÅu ch·ªânh ƒë·ªô r·ªông n·∫øu c·∫ßn */
        }
        /* Ki·ªÉu d√°ng cho modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            -top: 60px;
        }
        .modal-content {
            background-color: #fff;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 40%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            border-radius: 10px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover{
            text-decoration: none;
            cursor: pointer;
        }
        form {
            display: flex;
            flex-direction: column;
        }
        label {
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"] {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        input[type="submit"] {
            padding: 10px;
            border: none;
            border-radius: 5px;
            background-color: #888;
            color: white;
            font-size: 16px;
            cursor: pointer;
        }
        input[type="submit"]:hover {
            background-color: #888;
        }
        /* Ki·ªÉu d√°ng cho thanh t√¨m ki·∫øm */
        .search-container {
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
        }
        .search-container input[type="text"] {
            width: 300px;
            padding: 10px 20px;
            border: 1px solid #ddd;
            border-radius: 50px;
            font-size: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .search-container input[type="text"]:focus {
            border-color: #888;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            outline: none;
        }
        /* C√°ch b·∫£ng 10px */
        #addDepartmentBtn {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
<h1>Th√¥ng Tin Ph√≤ng Ban</h1>
<div class="search-container">
    <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm...">
</div>
<button id="addDepartmentBtn">Th√™m Ph√≤ng Ban</button>
<table id="departmentTable">
    <thead>
    <tr>
        <th>STT</th>
        <th>T√™n Ph√≤ng Ban</th>
        <th>T√™n Nh√¢n Vi√™n</th>
        <th>Vai Tr√≤</th>
        <th>H√†nh ƒê·ªông</th>
    </tr>
    </thead>
    <tbody>
    <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c ch√®n v√†o ƒë√¢y b·∫±ng JavaScript -->
    </tbody>
</table>

<!-- The Modal -->
<div id="myModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2 id="modalTitle">Th√™m Ph√≤ng Ban M·ªõi</h2>
        <form id="addDepartmentForm">
            <label for="departmentName">T√™n Ph√≤ng Ban:</label>
            <input type="text" id="departmentName" name="departmentName">
            <span id="departmentError" style="color: red;"></span>
            <label for="userName">T√™n Nh√¢n Vi√™n:</label>
            <input type="text" id="userName" name="userName">
            <span id="userError" style="color: red;"></span>
            <label for="roleName">Vai Tr√≤:</label>
            <input type="text" id="roleName" name="roleName">
            <input type="submit" value="Th√™m Ph√≤ng Ban">
        </form>
    </div>
</div>

<script>
    let editDepartmentId = null;

    // H√†m ƒë·ªÉ ƒëi·ªÅn d·ªØ li·ªáu v√†o b·∫£ng
    function populateTable(data) {
        const tableBody = document.getElementById('departmentTable').getElementsByTagName('tbody')[0];
        tableBody.innerHTML = ''; // X√≥a d·ªØ li·ªáu c≈©
        data.forEach((department, index) => {
            const row = tableBody.insertRow();
            row.dataset.id = department.departmentId; // L∆∞u ID ph√≤ng ban v√†o thu·ªôc t√≠nh dataset
            row.insertCell(0).textContent = index + 1; // S·ªë th·ª© t·ª±
            row.insertCell(1).textContent = department.departmentName;
            row.insertCell(2).textContent = department.userName;
            row.insertCell(3).textContent = department.roleName;
            const actionCell = row.insertCell(4);
            actionCell.innerHTML = `
            <button onclick="editDepartment(${department.departmentId}, '${department.departmentName}', '${department.userName}', '${department.roleName}')">‚úèÔ∏è</button>
            <button onclick="deleteDepartment(${department.departmentId})">üóëÔ∏è</button>
        `;
        });
    }

    // L·∫•y d·ªØ li·ªáu t·ª´ API backend
    async function fetchData() {
        try {
            const response = await fetch('/api/v1/departments/all'); // ƒêi·ªÅu ch·ªânh URL ƒë·ªÉ ph√π h·ª£p v·ªõi API backend
            const data = await response.json();
            populateTable(data);
        } catch (error) {
            console.error('L·ªói khi l·∫•y d·ªØ li·ªáu:', error);
        }
    }

    // M·ªü modal ƒë·ªÉ th√™m m·ªõi ph√≤ng ban
    function addDepartment() {
        editDepartmentId = null;
        document.getElementById('modalTitle').textContent = 'Th√™m Ph√≤ng Ban M·ªõi';
        document.getElementById('departmentName').value = '';
        document.getElementById('userName').value = '';
        document.getElementById('roleName').value = '';
        document.getElementById('addDepartmentForm').querySelector('input[type="submit"]').value = 'Th√™m Ph√≤ng Ban';
        document.getElementById('myModal').style.display = 'block';
    }

    // M·ªü modal ƒë·ªÉ ch·ªânh s·ª≠a ph√≤ng ban
    function editDepartment(id, departmentName, userName, roleName) {
        editDepartmentId = id; // L∆∞u ID ƒë·ªÉ d√πng khi c·∫≠p nh·∫≠t
        document.getElementById('modalTitle').textContent = 'S·ª≠a Ph√≤ng Ban';
        document.getElementById('departmentName').value = departmentName;
        document.getElementById('userName').value = userName;
        document.getElementById('roleName').value = roleName;
        document.getElementById('addDepartmentForm').querySelector('input[type="submit"]').value = 'C·∫≠p Nh·∫≠t Ph√≤ng Ban';
        document.getElementById('myModal').style.display = 'block';
    }

    // ƒê√≥ng modal
    function closeModal() {
        document.getElementById('myModal').style.display = 'none';
    }

    // G·ª≠i d·ªØ li·ªáu l√™n backend ƒë·ªÉ t·∫°o ho·∫∑c c·∫≠p nh·∫≠t ph√≤ng ban
    async function submitDepartment(event) {
        event.preventDefault();
        const departmentNameInput = document.getElementById('departmentName');
        const userNameInput = document.getElementById('userName');
        const roleNameInput = document.getElementById('roleName');
        const departmentName = departmentNameInput.value.trim();
        const userName = userNameInput.value.trim();
        const roleName = roleNameInput.value.trim();
        const departmentData = { departmentName, userName, roleName };
        // Clear previous error messages
        document.getElementById('departmentError').textContent = '';
        document.getElementById('userError').textContent = '';
        try {
            let response;
            if (editDepartmentId) {
                response = await fetch(`/api/v1/departments/${editDepartmentId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(departmentData)
                });
            } else {
                response = await fetch('/api/v1/departments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(departmentData)
                });
            }
            const result = await response.json();
            if (!response.ok) {
                if (result.message.includes('Department name already exists')) {
                    document.getElementById('departmentError').textContent = 'T√™n ph√≤ng ban ƒë√£ t·ªìn t·∫°i!';
                } else if (result.message.includes('Username already exists in this department')) {
                    document.getElementById('userError').textContent = 'Nh√¢n vi√™n n√†y ƒë√£ c√≥ trong ph√≤ng ban!';
                }
                throw new Error(result.message);
            }
            fetchData(); // Refresh the department list
            closeModal();
        } catch (error) {
            console.error('L·ªói:', error);
        }
    }

    // G·ª≠i y√™u c·∫ßu x√≥a ph√≤ng ban
    async function deleteDepartment(id) {
        if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ph√≤ng ban n√†y?')) return;
        try {
            const response = await fetch(`/api/v1/departments/${id}`, {
                method: 'DELETE',
            });
            if (!response.ok) throw new Error('L·ªói khi x√≥a ph√≤ng ban');
            fetchData(); // C·∫≠p nh·∫≠t l·∫°i b·∫£ng sau khi x√≥a
        } catch (error) {
            console.error('L·ªói:', error);
        }
    }

    // T√¨m ki·∫øm trong b·∫£ng
    document.getElementById('searchInput').addEventListener('keyup', function () {
        const filter = this.value.toLowerCase();
        const rows = document.getElementById('departmentTable').getElementsByTagName('tbody')[0].getElementsByTagName('tr');
        Array.from(rows).forEach(row => {
            const cells = row.getElementsByTagName('td');
            const match = Array.from(cells).some(cell => cell.textContent.toLowerCase().includes(filter));
            row.style.display = match ? '' : 'none';
        });
    });

    // ƒê√≥ng modal khi nh·∫•n v√†o d·∫•u "X"
    document.getElementsByClassName('close')[0].onclick = function () {
        closeModal();
    };

    // ƒê√≥ng modal khi nh·∫•n b√™n ngo√†i modal
    window.onclick = function (event) {
        const modal = document.getElementById('myModal');
        if (event.target == modal) {
            closeModal();
        }
    };

    // G√°n s·ª± ki·ªán cho form v√† n√∫t th√™m m·ªõi
    document.getElementById('addDepartmentForm').addEventListener('submit', submitDepartment);
    document.getElementById('addDepartmentBtn').addEventListener('click', addDepartment);

    // T·∫£i d·ªØ li·ªáu khi trang load
    document.addEventListener('DOMContentLoaded', fetchData);
</script>
</body>
</html>